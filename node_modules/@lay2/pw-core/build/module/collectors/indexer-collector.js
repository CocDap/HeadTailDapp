import { SUDTCollector } from './sudt-collector';
import { Amount, AmountUnit } from '..';
import { CkbIndexer, IndexerCellToCell, ScriptType, } from '../helpers/ckb-indexer';
export class IndexerCollector extends SUDTCollector {
    constructor(apiBase) {
        super();
        this.apiBase = apiBase;
        this.indexer = new CkbIndexer(apiBase);
    }
    async getBalance(address) {
        const searchKey = {
            script: address.toLockScript().serializeJson(),
            script_type: ScriptType.lock,
            filter: {
                output_data_len_range: ['0x0', '0x1'],
            },
        };
        const cells = (await this.indexer.getCells(searchKey)).filter((cell) => cell.output.type === null);
        let balance = Amount.ZERO;
        cells.forEach((cell) => {
            const amount = new Amount(cell.output.capacity, AmountUnit.shannon);
            balance = balance.add(amount);
        });
        return balance;
    }
    async collect(address, options) {
        if (!options || !options.neededAmount) {
            throw new Error("'neededAmount' in options must be provided");
        }
        let accCapacity = Amount.ZERO;
        const terminator = (_index, cell) => {
            if (accCapacity.gte(options.neededAmount)) {
                return { stop: true, push: false };
            }
            if (cell.output_data.length / 2 - 1 > 0 || cell.output.type !== null) {
                return { stop: false, push: false };
            }
            else {
                accCapacity = accCapacity.add(new Amount(cell.output.capacity, AmountUnit.shannon));
                return { stop: false, push: true };
            }
        };
        const searchKey = {
            script: address.toLockScript().serializeJson(),
            script_type: ScriptType.lock,
            filter: {
                output_data_len_range: ['0x0', '0x1'],
            },
        };
        const cells = await this.indexer.getCells(searchKey, terminator);
        return cells.map((cell) => IndexerCellToCell(cell));
    }
    async getSUDTBalance(sudt, address) {
        const searchKey = {
            script: address.toLockScript().serializeJson(),
            script_type: ScriptType.lock,
            filter: {
                script: sudt.toTypeScript().serializeJson(),
            },
        };
        const cells = await this.indexer.getCells(searchKey);
        let balance = Amount.ZERO;
        cells.forEach((cell) => {
            const amount = Amount.fromUInt128LE(cell.output_data);
            balance = balance.add(amount);
        });
        return balance;
    }
    async collectSUDT(sudt, address, options) {
        if (!options || !options.neededAmount) {
            throw new Error("'neededAmount' in options must be provided");
        }
        const searchKey = {
            script: address.toLockScript().serializeJson(),
            script_type: ScriptType.lock,
            filter: {
                script: sudt.toTypeScript().serializeJson(),
            },
        };
        let accCapacity = Amount.ZERO;
        const terminator = (_index, cell) => {
            if (accCapacity.gte(options.neededAmount)) {
                return { stop: true, push: false };
            }
            accCapacity = accCapacity.add(Amount.fromUInt128LE(cell.output_data));
            return { stop: false, push: true };
        };
        const cells = await this.indexer.getCells(searchKey, terminator);
        return cells.map((cell) => IndexerCellToCell(cell));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXhlci1jb2xsZWN0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29sbGVjdG9ycy9pbmRleGVyLWNvbGxlY3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFpQixNQUFNLEVBQUUsVUFBVSxFQUFRLE1BQU0sSUFBSSxDQUFDO0FBQzdELE9BQU8sRUFDTCxVQUFVLEVBRVYsaUJBQWlCLEVBRWpCLFVBQVUsR0FFWCxNQUFNLHdCQUF3QixDQUFDO0FBRWhDLE1BQU0sT0FBTyxnQkFBaUIsU0FBUSxhQUFhO0lBRWpELFlBQW1CLE9BQWU7UUFDaEMsS0FBSyxFQUFFLENBQUM7UUFEUyxZQUFPLEdBQVAsT0FBTyxDQUFRO1FBRWhDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVLENBQUMsT0FBZ0I7UUFDL0IsTUFBTSxTQUFTLEdBQUc7WUFDaEIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxhQUFhLEVBQVk7WUFDeEQsV0FBVyxFQUFFLFVBQVUsQ0FBQyxJQUFJO1lBQzVCLE1BQU0sRUFBRTtnQkFDTixxQkFBcUIsRUFBRSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQTJCO2FBQ2hFO1NBQ0YsQ0FBQztRQUNGLE1BQU0sS0FBSyxHQUFHLENBQUMsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FDM0QsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLElBQUksQ0FDcEMsQ0FBQztRQUNGLElBQUksT0FBTyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDMUIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ3JCLE1BQU0sTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNwRSxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNoQyxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQWdCLEVBQUUsT0FBeUI7UUFDdkQsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUU7WUFDckMsTUFBTSxJQUFJLEtBQUssQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO1NBQy9EO1FBQ0QsSUFBSSxXQUFXLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztRQUM5QixNQUFNLFVBQVUsR0FBZSxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRTtZQUM5QyxJQUFJLFdBQVcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxFQUFFO2dCQUN6QyxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUM7YUFDcEM7WUFDRCxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLElBQUksRUFBRTtnQkFDcEUsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDO2FBQ3JDO2lCQUFNO2dCQUNMLFdBQVcsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUMzQixJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsT0FBTyxDQUFDLENBQ3JELENBQUM7Z0JBQ0YsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO2FBQ3BDO1FBQ0gsQ0FBQyxDQUFDO1FBQ0YsTUFBTSxTQUFTLEdBQUc7WUFDaEIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxhQUFhLEVBQVk7WUFDeEQsV0FBVyxFQUFFLFVBQVUsQ0FBQyxJQUFJO1lBQzVCLE1BQU0sRUFBRTtnQkFDTixxQkFBcUIsRUFBRSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQTJCO2FBQ2hFO1NBQ0YsQ0FBQztRQUNGLE1BQU0sS0FBSyxHQUFHLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ2pFLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQsS0FBSyxDQUFDLGNBQWMsQ0FBQyxJQUFVLEVBQUUsT0FBZ0I7UUFDL0MsTUFBTSxTQUFTLEdBQUc7WUFDaEIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxhQUFhLEVBQVk7WUFDeEQsV0FBVyxFQUFFLFVBQVUsQ0FBQyxJQUFJO1lBQzVCLE1BQU0sRUFBRTtnQkFDTixNQUFNLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLGFBQWEsRUFBWTthQUN0RDtTQUNGLENBQUM7UUFDRixNQUFNLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3JELElBQUksT0FBTyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDMUIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ3JCLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3RELE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2hDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVELEtBQUssQ0FBQyxXQUFXLENBQ2YsSUFBVSxFQUNWLE9BQWdCLEVBQ2hCLE9BQXlCO1FBRXpCLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFO1lBQ3JDLE1BQU0sSUFBSSxLQUFLLENBQUMsNENBQTRDLENBQUMsQ0FBQztTQUMvRDtRQUNELE1BQU0sU0FBUyxHQUFHO1lBQ2hCLE1BQU0sRUFBRSxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUMsYUFBYSxFQUFZO1lBQ3hELFdBQVcsRUFBRSxVQUFVLENBQUMsSUFBSTtZQUM1QixNQUFNLEVBQUU7Z0JBQ04sTUFBTSxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxhQUFhLEVBQVk7YUFDdEQ7U0FDRixDQUFDO1FBQ0YsSUFBSSxXQUFXLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztRQUM5QixNQUFNLFVBQVUsR0FBZSxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRTtZQUM5QyxJQUFJLFdBQVcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxFQUFFO2dCQUN6QyxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUM7YUFDcEM7WUFDRCxXQUFXLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQ3RFLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQztRQUNyQyxDQUFDLENBQUM7UUFDRixNQUFNLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUNqRSxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDdEQsQ0FBQztDQUNGIn0=